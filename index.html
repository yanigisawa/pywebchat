<html>
<head><title>Web Chat</title></head>
<body>
<style>
    ul { list-style-type: none; }
    body { margin-left: 5px; }
    .metaData {
        font-weight: bold;
		font-size: 90%;
    }
	.messageLog {
		overflow: auto;
	}
	.input {
	}
	#message { width: 500px; }
</style>
<meta name="viewport" content="width=device-width, initial-scale=1"> 

<div class="messageLog">
	<div id="div1" style="height: 300px; display: block;">
		<div id="div2" style="height: inherit; overflow: auto; ">
	        <div id="messageLog"></div>
		</div>
	</div>
</div>

<div class="input"> 
	<label>Name:</label>
	<input type="text" id="userName" value="" />
	<label>Message:</label>
	<input type="text" id="message" value="" />
	<input type="button" id="newMessage" name="newMessage" value="Post"/>

</div>

<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.10.1/jquery.min.js"></script>
<script src="jquery.hotkeys.js"></script>
<script type="text/javascript">

var totalMessageCount = 0;
var titleToggleInterval;

function formatTime(d) {
    var a_p = "AM";
    d = new Date(d + "Z");
    var curr_hour = d.getHours();
    if (curr_hour >= 12) {
        a_p = "PM";
        curr_hour = curr_hour - 12;
    }

    if (curr_hour == 0) { curr_hour = 12; }

    var curr_min = d.getMinutes() + "";
    curr_hour = curr_hour + "";

    if (curr_min.length == 1) { curr_min = "0" + curr_min; }

    if (curr_hour.legth == 1) { curr_hour = "0" + curr_hour; }

    return curr_hour + ":" + curr_min + " " + a_p;
}

function printMessages(messageArr) {
    var messageCount = messageArr.length;
    var messages = "";
    for(var i = 0; i < messageCount; i++) {
        messages += "<span class='metaData'>";
        messages += messageArr[i].user + " - " ;
        messages += formatTime(messageArr[i].date);
        messages += "</span><span class='message'>";
        messages += ": " + messageArr[i].message + "</span><br/>";
    }
    $("#messageLog").html(messages);
	scrollToBottom();
}

function scrollToBottom() {
	height = $("#div2")[0].scrollHeight;
	$('#div2').animate( { scrollTop: height }, 1000); 
}

function postMessage() {

    if(!$.trim($("#userName").val()).length) {
        alert("Please enter a user name to post as.");
        return;
    }

    if(!$.trim($("#message").val()).length) {
        return;
    }


    $.ajax({
        type: "POST",
        url: "chat.py",
        dataType: "json",
        data: { 
            name: $("#userName").val(), 
            message: $("#message").val(),
        },
        success: function(result) {
            if (result.success) {
                printMessages(result.data);
            }
            $("#message").val("");
        },
        error: function() { 
            alert("failed ajax call."); 
        },
		complete: function() {
		}
    });
}

function readMessages() {
    $.ajax({
        type: "GET",
        url: "chat.py",
        dataType: "json",
        success: function(result) {
            if (result.success) {
                printMessages(result.data);
				totalMessageCount = result.data.length;
            }
        },
        error: function() { 
            alert("failed ajax call."); 
        },
		complete: function () {
		}
    });
}

$(document).ready(function() {
    $("#newMessage").click(function () {

        if($.trim($("#message").val()).length) {
            postMessage();
        }
    });

	$("#message").keypress(function (e) {
        if (e.keyCode == 13) {
            postMessage();
        }
    });

	$("#message").focus(function() { 
		clearInterval(titleToggleInterval); 
		document.title = "Web Chat";
	} );

    readMessages();
});

function toggleTitle() {
	var text = document.title;
	if (text == "New Message") { text = "Look Here"; }
	else { text = "New Message" }

	document.title = text;
}


(function poll(){
    $.ajax({ 
        url: "chat.py", 
        type: "POST",
        data: {
            poll: true
        },
        success: function(result){
            if (result.success) { 
                var shouldToggleTitleBar = result.data[result.data.length - 1].user != $("#userName").val();
				if (result.data.length > totalMessageCount && shouldToggleTitleBar) {
					totalMessageCount = result.data.length;
                    clearInterval(titleToggleInterval);
					titleToggleInterval = setInterval(toggleTitle, 1000);
				}
				printMessages(result.data); 
			}
        }, 
        dataType: "json", 
        complete: poll, 
        timeout: 30000 
    });
})();

</script>
</body>
</html>
